// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String   @id @default(uuid())
  username                  String   @unique
  email                     String   @unique
  password                  String
  fullName                  String?  @default("")
  profileImageUrl           String?  @default("")
  about                     String?  @default("")
  tags                      String[] @default([])
  skills                    String[] @default([])
  interests                 String[] @default([])
  socialLinks               Json?    @default("{}")
  education                 Json?    @default("[]")
  experience                Json?    @default("[]")
  projects                  Json?    @default("[]")
  profileCompletePercentage Int      @default(0)

  posts        Post[]
  interviews   Interview[]
  threads      Thread[]
  comments     Comment[]
  likedPosts   PostLike[]
  votedThreads ThreadVote[]
  savedPosts   SavedPost[]
  savedThreads SavedThread[]

  createdAt  DateTime     @default(now())
  Assessment Assessment[]
}

model Post {
  id       String @id @default(uuid())
  caption  String
  imageUrl String
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Interactions
  likes    PostLike[]
  comments Comment[]
  savedBy  SavedPost[]

  createdAt DateTime @default(now())
}

model Interview {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName          String? @default("Practice")
  jobRole              String? @default("SDE")
  difficulty           String? @default("moderate")
  interviewDurationSec Int     @default(0)
  transcript           Json?   @default("[]")
  metadata             Json?   @default("{}")

  overallScore           Float
  metricTechnical        Float
  metricBehavioral       Float
  metricCommunication    Float
  metricProblemSolving   Float
  metricCompanyKnowledge Float
  topicsCovered          String[]

  overallAssessment String @db.Text

  keyStrengths        String[]
  areasForImprovement String[]

  recommendation Recommendation
  reasoning      String         @db.Text

  createdAt DateTime @default(now())
}

enum Recommendation {
  STRONG_YES
  YES
  MAYBE
  NO
}

model Assessment {
  id          String  @id @default(uuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String?
  roleName    String?
  difficulty  String?

  overallScore    Float
  correctAnswers  Int
  totalQuestions  Int
  metricTechnical Float?
  metricAccuracy  Float?
  topicsCovered   String[]
  strengths       String[]
  improvements    String   @db.Text
  feedback        String   @db.Text

  detailedAnalysis Json @default("[]")

  createdAt DateTime @default(now())
}

model Thread {
  id          String   @id @default(uuid())
  title       String
  description String
  tags        String[] // ["Doubt", "Placement", "Confession"]
  collegeName String
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Interactions
  upvotes   Int          @default(0)
  downvotes Int          @default(0)
  votes     ThreadVote[]

  comments Comment[]
  savedBy  SavedThread[]

  createdAt DateTime @default(now())
}

model Comment {
  id      String @id @default(uuid())
  content String

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  postId String?
  post   Post?   @relation(fields: [postId], references: [id], onDelete: Cascade)

  threadId String?
  thread   Thread? @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Nested Replies
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
}

model PostLike {
  id     String @id @default(uuid())
  userId String
  postId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model ThreadVote {
  id       String   @id @default(uuid())
  userId   String
  threadId String
  type     VoteType

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
}

model SavedPost {
  id     String @id @default(uuid())
  userId String
  postId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model SavedThread {
  id       String @id @default(uuid())
  userId   String
  threadId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
}

enum VoteType {
  UP
  DOWN
}
